---
title: 垃圾回收机制
createTime: 2025/02/28 14:27:35
permalink: /demo/
---
JavaScript 的垃圾回收机制（Garbage Collection, GC）是自动管理内存的核心机制之一。它负责在程序运行过程中，自动检测和回收不再使用的内存，以避免内存泄漏（Memory Leak）和内存溢出（Memory Overflow）。以下是 JavaScript 垃圾回收机制的详细解释：

---

### 一、垃圾回收的基本概念

1. **内存管理**
   - 内存分为栈内存和堆内存。栈内存用于存储基本数据类型和函数调用，堆内存用于存储引用数据类型（如对象、数组等）。
   - 垃圾回收主要针对堆内存中的对象。

2. **什么是垃圾（Garbage）？**
   - 垃圾指的是程序中不再被引用或无法访问的对象（即已经不再使用的内存空间）。

3. **垃圾回收的目的**
   - 自动回收垃圾对象，释放内存，提高内存利用效率，防止内存泄漏。

---

### 二、垃圾回收的常见算法

JavaScript 引擎（如 V8、SpiderMonkey）通常结合多种垃圾回收算法来实现高效的内存管理。以下是主要的垃圾回收算法：

#### 1. 引用计数（Reference Counting）
   - **原理**：为每个对象维护一个引用计数器，记录有多少引用指向该对象。当引用计数为 0 时，对象被视为垃圾。
   - **优点**：实现简单，可实时回收垃圾。
   - **缺点**：无法处理循环引用问题。
   - **示例**：
     ```javascript
     let obj1 = {};
     let obj2 = {};
     obj1.ref = obj2; // obj1 引用 obj2
     obj2.ref = obj1; // obj2 引用 obj1（循环引用）
     ```
     即使 `obj1` 和 `obj2` 不再被外部引用，它们的引用计数仍为 1，导致内存泄漏。

#### 2. 标记-清除（Mark and Sweep）
   - **原理**：
     1. 从根对象（如全局对象、调用栈中的变量）出发，递归标记所有可达对象。
     2. 清除所有未被标记的对象，释放内存。
   - **优点**：可以处理循环引用问题。
   - **缺点**：需要暂停程序执行（Stop-The-World），可能导致性能问题。
   - **示例**：
     ```javascript
     function createObjects() {
         let objA = {};
         let objB = {};
         objA.ref = objB;
         objB.ref = objA;
     }
     createObjects(); // 函数执行后，objA 和 objB 无法访问，会被垃圾回收
     ```

#### 3. 标记-整理（Mark and Compact）
   - **原理**：在标记-清除的基础上，整理内存空间，将存活对象移动到连续的内存区域，减少内存碎片。
   - **优点**：提高内存利用率。
   - **缺点**：增加了内存移动的开销。

#### 4. 分代回收（Generational Collection）
   - **原理**：将对象分为新生代（Young Generation）和老生代（Old Generation）。
     - 新生代：存放生命周期短的对象，使用 Scavenge 算法（如复制算法）。
     - 老生代：存放生命周期长的对象，使用标记-清除或标记-整理算法。
   - **优点**：针对不同生命周期的对象采用不同的回收策略，提高效率。
   - **缺点**：实现复杂。

#### 5. 增量回收（Incremental Collection）
   - **原理**：将垃圾回收过程分成多个小步骤执行，减少单次停顿时间。
   - **优点**：提高程序的响应速度。
   - **缺点**：增加了总体垃圾回收的时间。

---

### 三、V8 引擎的垃圾回收机制

作为 JavaScript 最具代表性的引擎，V8 的垃圾回收机制具有以下特点：

1. **新生代回收（Scavenge 算法）**
   - 将新生代内存分为两个半空间（From-space 和 To-space）。
   - 将活跃对象从 From-space 复制到 To-space，清除非活跃对象。
   - 如果对象经过多次复制仍存活，则将其晋升到老生代。

2. **老生代回收**
   - 使用标记-清除和标记-整理算法，回收老生代对象。
   - 使用并行标记和增量标记技术，减少停顿时间。

3. **Orinoco 项目**
   - V8 的 Orinoco 项目专注于优化垃圾回收性能，引入了并发标记、增量回收等新技术。

---

### 四、如何优化垃圾回收？

1. **减少内存占用**
   - 避免创建不必要的对象，合理管理缓存，及时释放不再使用的引用。

2. **避免内存泄漏**
   - 清除未使用的定时器、事件监听器等。
   - 避免闭包中意外保留对大对象的引用。

3. **使用弱引用（WeakRef）**
   - 使用 `WeakRef` 或 `WeakMap`、`WeakSet` 来存储对象，避免阻止垃圾回收。

---

### 五、总结

JavaScript 的垃圾回收机制通过自动管理内存，极大减轻了开发者的负担。常用的垃圾回收算法包括引用计数、标记-清除、分代回收等。V8 引擎通过 Scavenge 算法、标记-清除算法以及增量回收等技术，实现了高效的内存管理。为优化